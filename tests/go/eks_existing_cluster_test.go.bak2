package tests

import (
	"testing"

	"github.com/castai/pulumi-castai/sdk/go/castai"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi"
	"github.com/stretchr/testify/assert"
)

// Tests for connecting existing EKS clusters to CAST AI

func TestConnectExistingEksCluster(t *testing.T) {
	err := pulumi.RunErr(func(ctx *pulumi.Context) error {
		// Connect existing cluster - in real scenario, cluster already exists in AWS
		cluster, err := castai.NewEksCluster(ctx, "existing-eks-cluster", &castai.EksClusterArgs{
			AccountId:               pulumi.String("123456789012"),
			Region:                  pulumi.String("us-east-1"),
			Name:                    pulumi.String("production-eks-cluster"), // Existing cluster name
			DeleteNodesOnDisconnect: pulumi.Bool(false),                     // Don't delete nodes when disconnecting		})
		assert.NoError(t, err)
		assert.NotNil(t, cluster)
		return nil
	}, pulumi.WithMocks("project", "stack", &CastAIMocks{}))

	assert.NoError(t, err)
}

func TestConnectExistingEksWithAssumeRole(t *testing.T) {
	err := pulumi.RunErr(func(ctx *pulumi.Context) error {
		// Real-world scenario: Using cross-account assume role
		assumeRoleArn := "arn:aws:iam::123456789012:role/CastAI-CrossAccountRole"

		cluster, err := castai.NewEksCluster(ctx, "existing-eks-assume-role", &castai.EksClusterArgs{
			AccountId:               pulumi.String("123456789012"),
			Region:                  pulumi.String("us-west-2"),
			Name:                    pulumi.String("staging-eks-cluster"),
			DeleteNodesOnDisconnect: pulumi.Bool(false),			AssumeRoleArn: pulumi.String(assumeRoleArn), // Use IAM role instead of access keys
		})
		assert.NoError(t, err)
		assert.NotNil(t, cluster)
		return nil
	}, pulumi.WithMocks("project", "stack", &CastAIMocks{}))

	assert.NoError(t, err)
}

func TestConnectExistingEksMinimalConfig(t *testing.T) {
	err := pulumi.RunErr(func(ctx *pulumi.Context) error {
		// Minimal config - just the required fields
		cluster, err := castai.NewEksCluster(ctx, "existing-eks-minimal", &castai.EksClusterArgs{
			AccountId:               pulumi.String("111111111111"),
			Region:                  pulumi.String("ap-southeast-1"),
			Name:                    pulumi.String("minimal-eks"),
			DeleteNodesOnDisconnect: pulumi.Bool(true),		})
		assert.NoError(t, err)
		assert.NotNil(t, cluster)
		return nil
	}, pulumi.WithMocks("project", "stack", &CastAIMocks{}))

	assert.NoError(t, err)
}

func TestConnectExistingEksProductionVsDev(t *testing.T) {
	err := pulumi.RunErr(func(ctx *pulumi.Context) error {
		// Production: keep nodes when disconnecting (safety)
		prodCluster, err := castai.NewEksCluster(ctx, "existing-eks-prod", &castai.EksClusterArgs{
			AccountId:               pulumi.String("333333333333"),
			Region:                  pulumi.String("us-east-1"),
			Name:                    pulumi.String("prod-critical-cluster"),
			DeleteNodesOnDisconnect: pulumi.Bool(false), // IMPORTANT: Don't delete in production		})
		assert.NoError(t, err)
		assert.NotNil(t, prodCluster)

		// Dev: can delete nodes when disconnecting
		devCluster, err := castai.NewEksCluster(ctx, "existing-eks-dev", &castai.EksClusterArgs{
			AccountId:               pulumi.String("333333333333"),
			Region:                  pulumi.String("us-west-2"),
			Name:                    pulumi.String("dev-test-cluster"),
			DeleteNodesOnDisconnect: pulumi.Bool(true), // Safe for dev environments		})
		assert.NoError(t, err)
		assert.NotNil(t, devCluster)

		return nil
	}, pulumi.WithMocks("project", "stack", &CastAIMocks{}))

	assert.NoError(t, err)
}

func TestConnectMultipleExistingEksClusters(t *testing.T) {
	err := pulumi.RunErr(func(ctx *pulumi.Context) error {
		regions := []string{"us-east-1", "us-west-2", "eu-west-1"}

		for i, region := range regions {
			cluster, err := castai.NewEksCluster(ctx, "existing-eks-"+region, &castai.EksClusterArgs{
				AccountId:               pulumi.String("444444444444"),
				Region:                  pulumi.String(region),
				Name:                    pulumi.String("cluster-" + region),
				DeleteNodesOnDisconnect: pulumi.Bool(false),			})
			assert.NoError(t, err)
			assert.NotNil(t, cluster, "Cluster %d should not be nil", i)
		}

		return nil
	}, pulumi.WithMocks("project", "stack", &CastAIMocks{}))

	assert.NoError(t, err)
}
